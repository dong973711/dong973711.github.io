{"version":3,"sources":["../../../../../assets/scripts/data/assets/scripts/data/DataMng.js"],"names":["LevelData","require","UserData","DataBase","cc","Class","ctor","loadCounts","levelData","userData","loadDataFromLocalFile","progressCb","completeCb","loadSavedData","keys","Object","log","JSON","stringify","filter","k","hasOwnProperty","length","key","obj","fileName","fileDir","loader","loadRes","JsonAsset","err","data","error","initData","call","json","loadData","saveDataToLocal","saveData"],"mappings":";;;;;;AAAA;;;;;;AAMA,IAAIA,YAAYC,QAAQ,aAAR,CAAhB;AACA,IAAIC,WAAWD,QAAQ,YAAR,CAAf;AACA,IAAIE,WAAWF,QAAQ,YAAR,CAAf;;AAEAG,GAAGC,KAAH,CAAS;AACLC,QADK,kBACE;AACH,aAAKC,UAAL,GAAkB,CAAlB;;AAEA;AACA,aAAKC,SAAL,GAAiB,IAAIR,SAAJ,EAAjB;;AAEA;AACA,aAAKS,QAAL,GAAgB,IAAIP,QAAJ,EAAhB;AACH,KATI;;;AAWL;;;;;AAKAQ,yBAhBK,iCAgBiBC,UAhBjB,EAgB6BC,UAhB7B,EAgByC;AAAA;;AAC1C;AACA,aAAKC,aAAL;;AAEA;AACA,YAAIC,OAAOC,OAAOD,IAAP,CAAY,IAAZ,CAAX;AACAV,WAAGY,GAAH,CAAO,eAAP,EAAwBC,KAAKC,SAAL,CAAeJ,IAAf,CAAxB;AACAA,eAAOA,KAAKK,MAAL,CAAY,UAACC,CAAD,EAAK;AACpB,mBAAO,MAAKC,cAAL,CAAoBD,CAApB,KAA2B,MAAKA,CAAL,aAAmBjB,QAArD;AACH,SAFM,CAAP;AAGAC,WAAGY,GAAH,CAAO,eAAP,EAAwBC,KAAKC,SAAL,CAAeJ,IAAf,CAAxB;;AAEA;AACA,YAAIA,KAAKQ,MAAL,IAAe,CAAf,IAAoB,KAAKV,UAA7B,EAAyC;AACrC,iBAAKA,UAAL;AACA;AACH;;AAhByC,mCAkBjCW,GAlBiC;AAmBtC,gBAAIC,MAAM,MAAKD,GAAL,CAAV;AACA,gBAAIE,WAAWD,IAAIE,OAAnB;AACAtB,eAAGuB,MAAH,CAAUC,OAAV,CAAkBH,QAAlB,EAA4BrB,GAAGyB,SAA/B,EAA0C,UAACC,GAAD,EAAMC,IAAN,EAAa;AACnD,oBAAID,GAAJ,EAAS;AACL1B,uBAAG4B,KAAH,CAAS,sBAAsBP,QAAtB,GAAiC,WAAjC,GAA+CK,GAAxD;AACH,iBAFD,MAEO;AACH,wBAAIN,IAAIS,QAAR,EAAkB;AACdT,4BAAIS,QAAJ,CAAaC,IAAb,CAAkBV,GAAlB,EAAuBO,KAAKI,IAA5B;AACH;AACJ;;AAED,sBAAK5B,UAAL;AACA,oBAAII,UAAJ,EAAgB;AACZA,+BAAW,MAAKJ,UAAhB,EAA4BO,KAAKQ,MAAjC;AACH;AACD,oBAAI,MAAKf,UAAL,IAAmBO,KAAKQ,MAA5B,EAAoC;;AAEhC,wBAAIV,UAAJ,EAAgB;AACZA;AACH;AACJ;AACJ,aAnBD;AArBsC;;AAAA;AAAA;AAAA;;AAAA;AAkB1C,iCAAgBE,IAAhB,8HAAsB;AAAA,oBAAbS,GAAa;;AAAA,sBAAbA,GAAa;AAuBrB;AAzCyC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA0C7C,KA1DI;;;AA4DL;AACAV,iBA7DK,2BA6DW;AACZ,aAAKJ,QAAL,CAAc2B,QAAd;AACH,KA/DI;;AAgEL;AACAC,mBAjEK,6BAiEa;AACd,aAAK5B,QAAL,CAAc6B,QAAd;AACH;AAnEI,CAAT","file":"DataMng.js","sourceRoot":"../../../../../assets/scripts/data","sourcesContent":["/**\n * Created by skyxu on 2019/11/25.\n *\n * 数据管理, 配置数据读取, 保存读取本读数据\n */\n\nlet LevelData = require(\"./LevelData\");\nlet UserData = require(\"./UserData\");\nlet DataBase = require(\"./DataBase\");\n\ncc.Class({\n    ctor() {\n        this.loadCounts = 0;\n\n        // todo: 每添加新的配置表都需要在这里创建对应的对象\n        this.levelData = new LevelData();\n\n        // 动态数据\n        this.userData = new UserData();\n    },\n\n    /**\n     * 读取本地配置文件\n     * @param progressCb(cur,total) 进度回调\n     * @param completeCb{Function} 读取结束回调\n     */\n    loadDataFromLocalFile(progressCb, completeCb) {\n        // 读取本地保存的用户数据\n        this.loadSavedData();\n\n        // 读取配置文件数据\n        let keys = Object.keys(this);\n        cc.log(\"====keys1: %s\", JSON.stringify(keys));\n        keys = keys.filter((k)=>{\n            return this.hasOwnProperty(k) && (this[k] instanceof DataBase);\n        });\n        cc.log(\"====keys2: %s\", JSON.stringify(keys));\n\n        // 没有需要加载的本地配置\n        if (keys.length <= 0 && this.completeCb) {\n            this.completeCb();\n            return;\n        }\n        \n        for (let key of keys) {\n            let obj = this[key];\n            let fileName = obj.fileDir;\n            cc.loader.loadRes(fileName, cc.JsonAsset, (err, data)=>{\n                if (err) {\n                    cc.error(\"load local data: \" + fileName + \", error: \" + err);\n                } else {\n                    if (obj.initData) {\n                        obj.initData.call(obj, data.json);\n                    }\n                }\n\n                this.loadCounts ++;\n                if (progressCb) {\n                    progressCb(this.loadCounts, keys.length);\n                }\n                if (this.loadCounts >= keys.length) {\n\n                    if (completeCb) {\n                        completeCb();\n                    }\n                }\n            });\n        }\n    },\n\n    // 从localStorage读取数据\n    loadSavedData() {\n        this.userData.loadData();\n    },\n    // 保存数据到localStorage\n    saveDataToLocal() {\n        this.userData.saveData();\n    }\n});\n"]}